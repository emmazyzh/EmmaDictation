<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dictation Practice Tool</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2em; position: relative; overflow-x: hidden; }
    textarea { width: 80%; height: 100px; font-size: 1em; padding: 0.5em; margin: 0.5em; }
    #status { margin-top: 1em; font-weight: bold; }
    .icon-btn { font-size: 1em; padding: 0.7em 1.5em; margin: 0.3em; border: none; border-radius: 5px; cursor: pointer; background-color: #4CAF50; color: white; }
    .voice-toggle { position: absolute; right: 10%; margin-top: -120px; text-align: right; }
    #voiceSelect { padding: 0.5em; font-size: 1em; }
    #progress { margin-top: 1em; font-size: 1em; }
    #ribbons {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9999;
      background: url('https://i.imgur.com/TFdUbJF.png') center center no-repeat;
      background-size: contain;
    }
    .tags-section { margin: 32px auto 40px; width:80%}
    .tags-title { font-size: 16px; margin: 0 0 10px; color: #374151; }
    .tags-wrap { display: flex; flex-wrap: wrap; gap: 8px; }
    .tag {
      display: inline-block; padding: 6px 10px; border-radius: 999px;
      border: 1px solid #e5e7eb; background: #f9fafb; font-size: 14px;
    }
  </style>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>
<body>
  <h1>Dictation Tool</h1>

  <div class="voice-toggle">
    <label for="voiceSelect">Voice:</label>
    <select id="voiceSelect">
      <option value="Evan">Evan</option>
      <option value="Tom">Tom</option>
      <option value="Samantha">Samantha</option>
      <option value="Zoe">Zoe</option>
    </select>
  </div>

  <p>Enter a comma-separated list of words:</p>
  <textarea id="wordInput" placeholder="e.g., apple, banana, chocolate"></textarea>

  <div class="controls">
    <button id="startBtn" class="icon-btn">Start</button>
    <button onclick="nextWord()" class="icon-btn">Next</button>
    <!--button onclick="playPreviousWord()" class="icon-btn">Last</!--button-->
    <button onclick="repeatCurrentWord()" class="icon-btn">Repeat</button>
  </div>

  <p id="progress"></p>
  <p id="status">Status: Waiting for input...</p>
  <section id="word-tags-section" class="tags-section">
      <div id="wordTags" class="tags-wrap"></div>
  </section>
  <div id="ribbons"></div>

  <script>
    let words = [];
    let index = 0;
    let voices = [];
    let selectedVoice = null;
    let isDictating = false;
    let wentBack = false;
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition = null;          // 复用同一个实例
    let recognitionActive = false;   // 是否处于onstart~onend之间
    let listenRetryTimer = null;     // 重试定时器


    function populateVoices() {
      voices = speechSynthesis.getVoices();
      const defaultVoiceName = document.getElementById('voiceSelect').value;
      selectedVoice = voices.find(v => v.name === defaultVoiceName) || voices[0];
    }

    speechSynthesis.onvoiceschanged = populateVoices;

    document.getElementById('voiceSelect').addEventListener('change', () => {
      const voiceName = document.getElementById('voiceSelect').value;
      selectedVoice = voices.find(v => v.name === voiceName) || voices[0];
    });

    function speakText(text) {
      // 播报前：若正在听，则先停（不会触发致命错误）
      if (recognition && recognitionActive) {
        try { recognition.stop(); } catch {}
      }

      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'en-US';
      // u.voice = selectedVoice; // 若你有自定义声音
      u.onend = () => {
        // 说完再进监听，避免自说自听造成 aborted
        listenNextCommand();
      };
      speechSynthesis.speak(u);
    }


    function updateProgress() {
      document.getElementById('progress').textContent = `Progress: ${Math.min(index, words.length)} / ${words.length}`;
    }

    function showRibbons() {
      const ribbonDiv = document.getElementById('ribbons');
      ribbonDiv.style.display = 'block';
      setTimeout(() => {
        ribbonDiv.style.display = 'none';
      }, 3000);
    }

    function listenNextCommand() {
      if (!SR) {
        document.getElementById('status').textContent =
          'SpeechRecognition not supported in this browser.';
        return;
      }

      // 初始化 & 仅绑定一次事件
      if (!recognition) {
        recognition = new SR();
        recognition.lang = 'en-US';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        recognition.onstart = () => { recognitionActive = true; };
        recognition.onend   = () => { recognitionActive = false; };

        recognition.onresult = (event) => {
          const transcript = (event.results?.[0]?.[0]?.transcript || '')
            .toLowerCase();
          document.getElementById('status').textContent = `Heard: "${transcript}"`;

          if (transcript.includes("next") || transcript.includes("move on")
              || transcript.includes("done") || transcript.includes("finished")
              || transcript.includes("completed")) {

            if (index >= words.length) {
              // 可选：说话前停止麦克风，避免自说自听
              if (recognitionActive) { try { recognition.stop(); } catch {} }
              speakText('Great job! You finished the dictation! See you next time.');
              document.getElementById('status').textContent =
                'Great job! You finished the dictation! See you next time.';
              showRibbons();
              return;
            }
            nextWord(); // 建议在 nextWord 的播报结束后再调用 listenNextCommand()
            return;

          } else if (transcript.includes("again") || transcript.includes("repeat")
                    || transcript.includes("pardon")) {
            repeatCurrentWord(); // 同上，播报结束后再进入监听
            return;

          } else if (transcript.includes("last") || transcript.includes("previous")
                    || transcript.includes("back")) {
            playPreviousWord(); // 同上
            return;
          }

          // 未识别到命令：稍后再听一次（避免立刻 start 导致竞争）
          scheduleStart(180);
        };

        recognition.onerror = (event) => {
          const err = String(event?.error || '').toLowerCase();
          // "aborted" 多为非致命（stop/切换导致），忽略即可
          if (err !== 'aborted') {
            document.getElementById('status').textContent = `Error: ${event.error}`;
          }
          // 若仍需继续听命令，稍后再尝试启动
          scheduleStart(220);
        };
      }

      // 安全地启动识别：不在TTS说话时、不在已激活时
      scheduleStart(0);

      function scheduleStart(delayMs) {
        clearTimeout(listenRetryTimer);
        listenRetryTimer = setTimeout(() => {
          // TTS 在说话就延后
          if (speechSynthesis.speaking) { scheduleStart(150); return; }
          // 已在监听中就不重复 start
          if (recognitionActive) return;
          try {
            recognition.start();
          } catch (e) {
            // 可能是 invalid_state：再等一下重试
            scheduleStart(200);
          }
        }, delayMs);
      }
    }


    function repeatCurrentWord() {
      if (index > 0 && index <= words.length) {
        const word = words[index - 1];
        speakText(word);
        setTimeout(() => listenNextCommand(), 1000);
      } else {
        listenNextCommand();
      }
    }

    function playPreviousWord() {
      if (index <= 1 || wentBack) {
        listenNextCommand();
        return;
      }
      index -= 2;
      wentBack = true;
      nextWord();
    }

    function nextWord() {
      if (!isDictating) return;
      if (index < words.length) {
        wentBack = false;
        const word = words[index++];
        document.getElementById('status').textContent = `Word: ${word}`;
        updateProgress();
        speakText(word);
        setTimeout(() => listenNextCommand(), 1000);
      } else {
        document.getElementById('status').textContent = 'Great job! You finished the dictation! See you next time.';
        speakText('Great job! You finished the dictation! See you next time.');
        showRibbons();
        updateProgress();
        isDictating = false;
      }
    }

    function startDictation() {
      const voiceName = document.getElementById('voiceSelect').value;
      selectedVoice = voices.find(v => v.name === voiceName) || voices[0];
      words = document.getElementById('wordInput').value.split(/\r?\n|,/).map(w => w.trim()).filter(Boolean);
      index = 0;
      wentBack = false;
      if (words.length === 0) {
        document.getElementById('status').textContent = 'Please enter some words.';
        return;
      }
      renderWordTags(words);
      isDictating = true;
      document.getElementById('status').textContent = 'Starting dictation...';
      updateProgress();
      nextWord();
    }

    function renderWordTags(list) {
      const box = document.getElementById('wordTags');
      if (!box) return;
      box.innerHTML = '';
      list.forEach(w => {
        const s = document.createElement('span');
        s.className = 'tag';
        s.textContent = w;
        box.appendChild(s);
      });
    }
    document.getElementById('startBtn').onclick = startDictation;
  </script>
</body>
</html>
